# Home Assistant Generator Workflow

## Overview

This project uses a code-generation approach for Home Assistant configuration:
1. **Inventory**: Fetch entity/area/scene data from Home Assistant
2. **Generate**: Create YAML packages and Lovelace dashboards from templates
3. **Ship**: Deploy to production Home Assistant server

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              DEV MACHINE (Mac)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │   inventory  │───▶│   generate   │───▶│     ship     │                  │
│  └──────────────┘    └──────────────┘    └──────────────┘                  │
│         │                   │                   │                          │
│         ▼                   ▼                   ▼                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │  inventory/  │    │  packages/   │    │  git push    │                  │
│  │  hass-data   │    │  lovelace/   │    │  + SSH       │                  │
│  └──────────────┘    └──────────────┘    └──────────────┘                  │
│                                                 │                          │
└─────────────────────────────────────────────────│──────────────────────────┘
                                                  │
                                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PROD (Home Assistant Server)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │  git pull    │───▶│  ha check    │───▶│  ha restart  │                  │
│  └──────────────┘    └──────────────┘    └──────────────┘                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Commands

### NPX Commands (hass-generator tool)

| Command | Description |
|---------|-------------|
| `npx hass-gen inventory` | Fetch entities, areas, scenes, labels from HA → saves to `inventory/` |
| `npx hass-gen generate` | Read inventory + configs → generate `packages/` and `lovelace/` |
| `npx hass-gen generate --yaml-only` | Generate only YAML packages |
| `npx hass-gen generate --dashboard-only` | Generate only dashboards |
| `npx hass-gen init` | Initialize a new HA config project with starter files |

### Shell Scripts (scripts/)

| Script | Runs On | Description |
|--------|---------|-------------|
| `scripts/rebuild.sh` | Dev | Full pipeline: inventory → generate → ship |
| `scripts/ship.sh` | Dev | Push to GitHub, trigger prod deploy |
| `scripts/deploy.sh` | Prod | Pull from GitHub, merge, restart HA |

---

## Typical Workflows

### After changing Home Assistant (entities, areas, scenes)

```bash
./scripts/rebuild.sh
```

This fetches fresh data, regenerates everything, and deploys.

### After changing config files only

```bash
npx hass-gen generate
./scripts/ship.sh
```

No need to re-fetch inventory if HA entities haven't changed.

### Quick iteration (dashboard tweaks)

```bash
npx hass-gen generate --dashboard-only
./scripts/ship.sh
```

---

## File Structure

```
hass-config/
├── configuration.yaml      # Main HA config (manual)
├── automations.yaml        # HA automations (UI-managed)
├── scripts.yaml            # HA scripts (UI-managed)
├── scenes.yaml             # HA scenes (UI-managed)
│
├── generator.config.js     # YAML package generation config
├── dashboards/             # Dashboard configs
│   └── main.config.js      # Main dashboard config
├── users.js                # User ID constants
│
├── inventory/              # Generated by `hass-gen inventory`
│   ├── hass-data.json      # Raw HA data
│   ├── entities.js         # Entity reference by area
│   └── types/              # TypeScript definitions
│
├── packages/               # Generated by `hass-gen generate`
│   ├── areas/              # Per-area YAML packages
│   └── labels/             # Per-label YAML packages
│
├── lovelace/               # Generated dashboards
│   └── main.yaml           # Main Bubble Card dashboard
│
└── scripts/                # Deployment scripts
    ├── rebuild.sh          # Dev: inventory + generate + ship
    ├── ship.sh             # Dev: push + trigger prod deploy
    └── deploy.sh           # Prod: pull + merge + restart
```

---

## Setup

### Dev Machine (Mac)

1. Clone the repo
2. Install dependencies: `npm install`
3. Create `.env` with HA connection:
   ```
   HASS_HOST=homeassistant.local
   HASS_TOKEN=your_long_lived_token
   ```
4. Run initial inventory: `npx hass-gen inventory`

### Prod (Home Assistant)

1. Clone repo to `/root/config`
2. Symlink deploy script: `ln -sf /root/config/scripts/deploy.sh /root/deploy.sh`
3. Ensure SSH access from dev machine

---

## Branching Strategy

- **Feature branches** (e.g., `add-new-room`): Development work
- **main**: Production-ready, deployed to HA

The `ship.sh` script:
1. Pushes your feature branch to GitHub
2. Triggers prod to pull and test the branch
3. If config check passes, merges to main and restarts HA

